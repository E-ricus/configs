#!/usr/bin/env bash
# Smart NixOS Installer with Interactive Partitioning
# Run this from the NixOS LIVE installer environment
# Usage:
#   Download first: curl -fsSL https://raw.githubusercontent.com/e-ricus/configs/main/bootstrap/0 > install.sh
#   Then run with: sudo bash install.sh

set -euo pipefail

# Source shared functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/lib.sh" ]; then
    source "$SCRIPT_DIR/lib.sh"
else
    # If running from curl, download lib.sh
    eval "$(curl -fsSL https://raw.githubusercontent.com/e-ricus/configs/main/bootstrap/lib.sh)"
fi

# Configuration
TARGET_USER="ericus"  # Change this if you use a different username in your flake
TARGET_UID="1000"
TARGET_GID="100"
GITHUB_USER="e-ricus"
CONFIGS_REPO="https://github.com/$GITHUB_USER/configs"

#############################################
# Helper Functions
#############################################

verify_installer_environment() {
    log_info "Verifying installer environment..."
    
    # Check if running NixOS
    if [ "$(detect_system)" != "nixos" ]; then
        log_error "This script must be run from NixOS installer!"
        log_info "For post-install setup, use: bootstrap/1"
        exit 1
    fi
    
    log_success "Running in NixOS installer environment"
}


detect_disks() {
    log_info "Detecting available disks..."
    echo
    lsblk -o NAME,SIZE,TYPE,FSTYPE,MOUNTPOINT -e 7,11
    echo
}

select_disk() {
    log_info "=== Disk Selection ==="
    echo
    
    # Get list of disks (excluding loop and rom devices)
    mapfile -t DISKS < <(lsblk -ndo NAME,SIZE,TYPE -e 7,11 | grep 'disk' | awk '{print $1}')
    
    if [ ${#DISKS[@]} -eq 0 ]; then
        log_error "No disks found!"
        exit 1
    fi
    
    # Display available disks
    log_info "Available disks:"
    for i in "${!DISKS[@]}"; do
        local disk="${DISKS[$i]}"
        local size=$(lsblk -ndo SIZE "/dev/$disk")
        local model=$(lsblk -ndo MODEL "/dev/$disk" 2>/dev/null || echo "Unknown")
        echo "  $((i+1))) /dev/$disk - $size - $model"
    done
    echo
    
    # Prompt for selection
    while true; do
        read -p "Select disk number (1-${#DISKS[@]}): " selection
        if [[ "$selection" =~ ^[0-9]+$ ]] && [ "$selection" -ge 1 ] && [ "$selection" -le ${#DISKS[@]} ]; then
            SELECTED_DISK="/dev/${DISKS[$((selection-1))]}"
            break
        else
            log_error "Invalid selection. Please try again."
        fi
    done
    
    echo
    log_warning "WARNING: All data on $SELECTED_DISK will be DESTROYED!"
    echo
    if ! confirm "Continue with $SELECTED_DISK?"; then
        log_info "Installation cancelled"
        exit 0
    fi
    
    log_success "Selected disk: $SELECTED_DISK"
}

get_partition_sizes() {
    log_info "=== Partition Configuration ==="
    echo
    
    local disk_size_gb=$(lsblk -ndo SIZE "$SELECTED_DISK" | sed 's/G//')
    log_info "Total disk size: ${disk_size_gb}G"
    echo
    
    # EFI partition size
    log_info "EFI System Partition (recommended: 512M-1G)"
    read -p "Enter EFI size in MB [default: 512]: " EFI_SIZE
    EFI_SIZE=${EFI_SIZE:-512}
    
    # Swap partition
    log_info "Swap partition (recommended: 4G-8G, 0 to skip)"
    read -p "Enter swap size in GB [default: 8]: " SWAP_SIZE
    SWAP_SIZE=${SWAP_SIZE:-8}
    
    # Root gets the rest
    log_success "Root partition will use remaining space"
    
    echo
    log_info "Partition plan:"
    echo "  1. EFI:  ${EFI_SIZE}M"
    if [ "$SWAP_SIZE" != "0" ]; then
        echo "  2. Swap: ${SWAP_SIZE}G"
        echo "  3. Root: Remaining space"
    else
        echo "  2. Root: Remaining space"
    fi
    echo
    
    if ! confirm "Proceed with this partition plan?"; then
        log_info "Installation cancelled"
        exit 0
    fi
}

partition_disk() {
    log_info "=== Partitioning Disk ==="
    echo
    
    log_info "Creating GPT partition table on $SELECTED_DISK..."
    parted -s "$SELECTED_DISK" mklabel gpt
    
    log_info "Creating EFI partition (${EFI_SIZE}M)..."
    parted -s "$SELECTED_DISK" mkpart ESP fat32 1MiB ${EFI_SIZE}MiB
    parted -s "$SELECTED_DISK" set 1 esp on
    
    local next_start="${EFI_SIZE}MiB"
    local part_num=2
    
    if [ "$SWAP_SIZE" != "0" ]; then
        local swap_end=$((EFI_SIZE + SWAP_SIZE * 1024))
        log_info "Creating swap partition (${SWAP_SIZE}G)..."
        parted -s "$SELECTED_DISK" mkpart primary linux-swap ${next_start} ${swap_end}MiB
        next_start="${swap_end}MiB"
        part_num=3
    fi
    
    log_info "Creating root partition (remaining space)..."
    parted -s "$SELECTED_DISK" mkpart primary ext4 ${next_start} 100%
    
    # Wait for kernel to re-read partition table
    sleep 2
    partprobe "$SELECTED_DISK"
    sleep 2
    
    log_success "Partitioning complete"
    echo
    lsblk "$SELECTED_DISK"
}

format_partitions() {
    log_info "=== Formatting Partitions ==="
    echo
    
    # Determine partition naming scheme
    if [[ "$SELECTED_DISK" == *"nvme"* ]] || [[ "$SELECTED_DISK" == *"mmcblk"* ]]; then
        PART_PREFIX="${SELECTED_DISK}p"
    else
        PART_PREFIX="${SELECTED_DISK}"
    fi
    
    EFI_PART="${PART_PREFIX}1"
    
    if [ "$SWAP_SIZE" != "0" ]; then
        SWAP_PART="${PART_PREFIX}2"
        ROOT_PART="${PART_PREFIX}3"
    else
        SWAP_PART=""
        ROOT_PART="${PART_PREFIX}2"
    fi
    
    log_info "Formatting EFI partition as FAT32..."
    mkfs.fat -F 32 "$EFI_PART"
    
    if [ -n "$SWAP_PART" ]; then
        log_info "Setting up swap..."
        mkswap "$SWAP_PART"
    fi
    
    log_info "Formatting root partition as ext4..."
    mkfs.ext4 -F "$ROOT_PART"
    
    log_success "Formatting complete"
}

mount_partitions() {
    log_info "=== Mounting Partitions ==="
    echo
    
    log_info "Mounting root partition to /mnt..."
    mount "$ROOT_PART" /mnt
    
    log_info "Creating /mnt/boot directory..."
    mkdir -p /mnt/boot
    
    log_info "Mounting EFI partition to /mnt/boot..."
    mount "$EFI_PART" /mnt/boot
    
    if [ -n "$SWAP_PART" ]; then
        log_info "Enabling swap..."
        swapon "$SWAP_PART"
    fi
    
    log_success "All partitions mounted"
    echo
    log_info "Current mount configuration:"
    lsblk -o NAME,SIZE,TYPE,FSTYPE,MOUNTPOINT | grep -E "(mnt|NAME)"
    echo
}

generate_hardware_config() {
    log_info "=== Generating Hardware Configuration ==="
    echo

    log_info "Running nixos-generate-config..."
    if nixos-generate-config --root /mnt; then
        log_success "Configuration generated successfully"
    else
        log_error "Failed to generate configuration!"
        exit 1
    fi

    echo
    log_info "Verifying generated files..."

    if [ ! -f /mnt/etc/nixos/hardware-configuration.nix ]; then
        log_error "hardware-configuration.nix not found!"
        exit 1
    fi
    log_success "✓ /mnt/etc/nixos/hardware-configuration.nix"

    echo
    log_info "Generated hardware configuration contains:"
    echo
    grep -E "(fileSystems|swapDevices|boot\.loader)" /mnt/etc/nixos/hardware-configuration.nix || true
    echo
}

configure_wifi() {
    log_info "=== WiFi Configuration ==="
    echo

    log_info "WiFi configuration is needed if:"
    log_info "  • You're installing on a laptop or device without ethernet"
    log_info "  • You need network access after the first reboot"
    echo
    log_info "WiFi is NOT needed if:"
    log_info "  • Installing on a VM"
    log_info "  • Installing on a device with ethernet connection"
    echo

    if confirm "Do you need WiFi configured for the installed system?"; then
        echo
        read -p "Enter WiFi network SSID: " WIFI_SSID

        if [ -z "$WIFI_SSID" ]; then
            log_error "SSID cannot be empty!"
            exit 1
        fi

        read -sp "Enter WiFi password: " WIFI_PSK
        echo

        if [ -z "$WIFI_PSK" ]; then
            log_error "Password cannot be empty!"
            exit 1
        fi

        log_success "WiFi will be configured for network: $WIFI_SSID"
        CONFIGURE_WIFI=true
    else
        log_info "Skipping WiFi configuration"
        CONFIGURE_WIFI=false
    fi
}

add_wifi_to_config() {
    if [ "$CONFIGURE_WIFI" = false ]; then
        return
    fi

    log_info "=== Adding WiFi to Configuration ==="
    echo

    local config_file="/mnt/etc/nixos/configuration.nix"

    if [ ! -f "$config_file" ]; then
        log_error "Configuration file not found: $config_file"
        exit 1
    fi

    # Create WiFi configuration snippet
    local wifi_config="  # WiFi configuration
  networking.wireless.enable = true;  # Enables wireless support via wpa_supplicant.
  networking.wireless.networks = {
    \"$WIFI_SSID\" = {
      psk = \"$WIFI_PSK\";
    };
  };"

    # Find the line with "networking.hostName" (commented or not) and add WiFi config after it
    # If that line doesn't exist, add it after the boot.loader section
    if grep -q "networking.hostName" "$config_file"; then
        # Add after networking.hostName line
        sed -i "/networking\.hostName/a\\
$wifi_config" "$config_file"
    elif grep -q "boot\.loader" "$config_file"; then
        # Add after the last boot.loader line
        local last_boot_line=$(grep -n "boot\.loader" "$config_file" | tail -1 | cut -d: -f1)
        sed -i "${last_boot_line}a\\
\\
$wifi_config" "$config_file"
    else
        # Fallback: add after the imports section closing bracket
        sed -i "/];/a\\
\\
$wifi_config" "$config_file"
    fi

    log_success "WiFi configuration added to $config_file"
    echo
    log_info "WiFi section added:"
    echo "$wifi_config"
    echo
}


run_nixos_install() {
    log_info "=== Running NixOS Installation ==="
    echo
    
    log_warning "This will install NixOS to /mnt"
    log_info "The installation will:"
    log_info "  1. Install all system packages"
    log_info "  2. Set up the bootloader"
    log_info "  3. Create user '$TARGET_USER'"
    log_info "  4. Ask you to set the root password"
    log_info "  5. Ask you to set the user password"
    echo
    
    if ! confirm "Proceed with installation?"; then
        log_info "Installation cancelled"
        exit 0
    fi
    
    echo
    log_info "Starting installation (this may take 10-30 minutes)..."
    echo
    
    if nixos-install; then
        echo
        log_success "╔════════════════════════════════════════╗"
        log_success "║   NixOS Installation Complete!         ║"
        log_success "╚════════════════════════════════════════╝"
    else
        echo
        log_error "Installation failed!"
        log_error "Please check the error messages above"
        log_info "You can try to fix issues and re-run: nixos-install"
        exit 1
    fi
}

#############################################
# Main Function
#############################################

main() {
    echo
    log_info "╔════════════════════════════════════════╗"
    log_info "║   NixOS Smart Installer               ║"
    log_info "║   Interactive Partition Setup         ║"
    log_info "╚════════════════════════════════════════╝"
    echo
    
    log_warning "This script will:"
    log_info "  • Help you partition your disk interactively"
    log_info "  • Format and mount all partitions"
    log_info "  • Generate hardware configuration"
    log_info "  • Optionally configure WiFi for the installed system"
    log_info "  • Install NixOS with generated config"
    echo
    
    if ! confirm "Ready to begin?"; then
        log_info "Installation cancelled"
        exit 0
    fi
    
    echo

    # Phase 1: Pre-flight checks
    verify_installer_environment

    echo
    
    # Phase 2: Interactive disk setup
    log_info "=== Phase 1: Disk Preparation ==="
    echo
    
    detect_disks
    select_disk
    get_partition_sizes
    
    echo
    log_warning "FINAL WARNING: This will DESTROY all data on $SELECTED_DISK"
    if ! confirm "Type 'yes' to continue"; then
        log_info "Installation cancelled"
        exit 0
    fi
    
    echo
    partition_disk
    
    echo
    format_partitions
    
    echo
    mount_partitions
    
    echo

    # Phase 3: Generate hardware config
    log_info "=== Phase 2: Hardware Configuration ==="
    echo
    generate_hardware_config

    echo

    # Phase 3.5: Configure WiFi (optional)
    configure_wifi

    echo

    # Add WiFi to configuration if needed
    add_wifi_to_config

    echo

    # Phase 4: Run installation
    log_info "=== Phase 3: System Installation ==="
    echo
    run_nixos_install
    
    echo
    log_info "╔════════════════════════════════════════╗"
    log_info "║        Next Steps                      ║"
    log_info "╚════════════════════════════════════════╝"
    echo
    log_info "1. Reboot into your new system: reboot"
    log_info "2. Login as root (user doesn't exist yet)"
    log_info "3. Run post-install setup:"
    log_info "   curl -fsSL https://raw.githubusercontent.com/$GITHUB_USER/configs/main/bootstrap/1 > setup.sh"
    log_info "   bash setup.sh"
    echo
    log_info "The post-install script will:"
    log_info "  • Clone your configs"
    log_info "  • Copy hardware-configuration.nix to configs"
    log_info "  • Rebuild system using your flake"
    log_info "  • Set up user password"
    echo
    
    if confirm "Reboot now?"; then
        log_info "Rebooting..."
        reboot
    else
        log_info "Remember to reboot before running bootstrap/1"
    fi
}

main "$@"
