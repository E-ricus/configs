#!/usr/bin/env bash
# Bootstrap script for post-installation setup
# Works on NixOS, macOS, and other Linux distributions
# Usage: curl -fsSL https://raw.githubusercontent.com/e-ricus/.dotfiles/main/bootstrap/1 | bash

set -euo pipefail

# Source shared functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/lib.sh" ]; then
    source "$SCRIPT_DIR/lib.sh"
else
    # If running from curl, download lib.sh
    eval "$(curl -fsSL https://raw.githubusercontent.com/e-ricus/.dotfiles/main/bootstrap/lib.sh)"
fi

DOTFILES_DIR="$HOME/.dotfiles"

setup_nixos() {
    log_info "=== Setting up NixOS ==="
    
    # Check if dotfiles exist, if not clone
    if [ ! -d "$DOTFILES_DIR" ]; then
        log_info "Dotfiles not found in home directory, cloning..."
        ensure_git
        clone_dotfiles "$DOTFILES_DIR"
    else
        log_success "Dotfiles already exist at $DOTFILES_DIR"
    fi
    
    # Copy hardware-configuration.nix from /etc/nixos to dotfiles
    log_info "Copying hardware-configuration.nix to dotfiles..."
    if [ -f /etc/nixos/hardware-configuration.nix ]; then
        # Backup existing if present
        if [ -f "$DOTFILES_DIR/nix/nixos/hardware-configuration.nix" ]; then
            local backup="$DOTFILES_DIR/nix/nixos/hardware-configuration.nix.backup.$(date +%Y%m%d_%H%M%S)"
            mv "$DOTFILES_DIR/nix/nixos/hardware-configuration.nix" "$backup"
            log_info "Backed up existing hardware config to $(basename $backup)"
        fi
        
        cp /etc/nixos/hardware-configuration.nix "$DOTFILES_DIR/nix/nixos/"
        log_success "Hardware configuration copied to dotfiles"
    else
        log_error "Hardware configuration not found at /etc/nixos/hardware-configuration.nix"
        log_error "Cannot proceed without hardware configuration"
        exit 1
    fi
    
    echo
    log_info "Hardware configuration is now in:"
    log_info "  $DOTFILES_DIR/nix/nixos/hardware-configuration.nix"
    echo
    
    # Detect system architecture
    local arch=$(uname -m)
    local flake_config=""
    case $arch in
        x86_64)
            flake_config="nixos-x86"
            ;;
        aarch64)
            flake_config="nixos-arm"
            ;;
        *)
            log_error "Unsupported architecture: $arch"
            exit 1
            ;;
    esac
    
    log_info "Detected architecture: $arch"
    log_info "Using flake configuration: $flake_config"
    echo
    
    # Rebuild using flake
    if confirm "Rebuild NixOS using flake configuration?"; then
        log_info "Rebuilding NixOS from flake..."
        log_info "This may take several minutes on first run..."
        echo
        
        if sudo nixos-rebuild switch --flake "$DOTFILES_DIR/nix/nixos#$flake_config"; then
            log_success "NixOS rebuilt successfully with flake!"
        else
            log_error "Failed to rebuild NixOS!"
            log_info "You can try manually with:"
            log_info "  sudo nixos-rebuild switch --flake $DOTFILES_DIR/nix/nixos#$flake_config"
            exit 1
        fi
    else
        log_info "Skipping rebuild. You can rebuild later with:"
        log_info "  sudo nixos-rebuild switch --flake $DOTFILES_DIR/nix/nixos#$flake_config"
    fi
}

setup_darwin() {
    log_info "=== Setting up macOS with nix-darwin ==="
    
    # Check if darwin configuration exists
    if [ ! -f "$DOTFILES_DIR/nix/darwin/flake.nix" ]; then
        log_error "Darwin configuration not found!"
        log_error "Expected: $DOTFILES_DIR/nix/darwin/flake.nix"
        echo
        log_info "Darwin/macOS configuration needs to be created manually."
        log_info "Please create nix/darwin/flake.nix in your dotfiles first."
        echo
        log_warning "Skipping darwin setup..."
        return 1
    fi
    
    # Ensure git
    ensure_git
    
    # Clone dotfiles if needed
    if [ ! -d "$DOTFILES_DIR" ]; then
        clone_dotfiles "$DOTFILES_DIR"
    fi
    
    # Install Nix if needed
    install_nix
    
    # Source Nix profile
    if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
        . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
    fi
    
    # Install nix-darwin
    log_info "Installing nix-darwin..."
    nix run nix-darwin -- switch --flake "$DOTFILES_DIR/nix/darwin"
    
    log_success "nix-darwin installed and configured"
}

setup_linux() {
    log_info "=== Setting up Linux with standalone home-manager ==="
    
    # Ensure git
    ensure_git
    
    # Clone dotfiles if needed
    if [ ! -d "$DOTFILES_DIR" ]; then
        clone_dotfiles "$DOTFILES_DIR"
    fi
    
    # Install Nix
    install_nix
    
    # Source Nix profile
    if [ -e "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
        . "$HOME/.nix-profile/etc/profile.d/nix.sh"
    fi
    
    log_success "Nix installed for standalone Linux"
}

setup_home_manager() {
    log_info "=== Setting up home-manager ==="
    
    # Symlink home-manager config
    local hm_source="$DOTFILES_DIR/nix/home-manager"
    local hm_target="$HOME/.config/home-manager"
    
    # Check if home-manager flake exists
    if [ ! -f "$hm_source/flake.nix" ]; then
        log_error "home-manager flake not found at $hm_source/flake.nix"
        log_error "Cannot proceed with home-manager setup"
        return 1
    fi
    
    create_symlink "$hm_source" "$hm_target"
    
    # Determine which user configuration to use
    local hm_user=$(get_hm_user)
    log_info "Using home-manager configuration for: $hm_user"
    
    # Check if the user configuration exists
    local system=$(detect_system)
    local user_config=""
    case $system in
        nixos|linux)
            user_config="$hm_source/homes/linux.nix"
            ;;
        darwin)
            user_config="$hm_source/homes/mac.nix"
            ;;
    esac
    
    if [ ! -f "$user_config" ]; then
        log_error "User configuration not found: $user_config"
        return 1
    fi
    
    # Initialize home-manager flake
    log_info "Initializing home-manager..."
    cd "$hm_target"
    
    if [ ! -f "flake.lock" ]; then
        log_info "Generating flake.lock..."
        nix flake update
    fi
    
    # Apply home-manager configuration
    log_info "Applying home-manager configuration..."
    log_info "This may take several minutes on first run..."
    
    if home-manager switch --flake "$hm_target#$hm_user"; then
        log_success "home-manager configured successfully"
    else
        log_error "home-manager switch failed!"
        log_info "You can try manually with: home-manager switch --flake ~/.config/home-manager#$hm_user"
        return 1
    fi
}

setup_symlinks() {
    log_info "=== Setting up dotfile symlinks ==="
    
    # Verify symlinkmanager exists
    if [ ! -x "$DOTFILES_DIR/bin/symlinkmanager" ]; then
        log_error "symlinkmanager not found at $DOTFILES_DIR/bin/symlinkmanager"
        log_error "Cannot proceed with dotfile symlinking"
        return 1
    fi
    
    # Verify symlink.conf exists
    if [ ! -f "$DOTFILES_DIR/symlink.conf" ]; then
        log_error "symlink.conf not found at $DOTFILES_DIR/symlink.conf"
        log_error "Cannot proceed with dotfile symlinking"
        return 1
    fi
    
    # Run symlinkmanager
    stow_configs "$DOTFILES_DIR"
    
    log_success "All dotfiles symlinked"
}

main() {
    echo
    log_info "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    log_info "‚ïë   Dotfiles Bootstrap - Post Install   ‚ïë"
    log_info "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo
    
    # Detect system
    SYSTEM=$(detect_system)
    log_info "Detected system: $SYSTEM"
    echo
    
    # System-specific setup
    case $SYSTEM in
        nixos)
            setup_nixos
            ;;
        darwin)
            if ! setup_darwin; then
                log_warning "Darwin setup failed or was skipped"
                log_info "Continuing with home-manager setup..."
            fi
            ;;
        linux)
            setup_linux
            ;;
        *)
            log_error "Unsupported system type: $SYSTEM"
            exit 1
            ;;
    esac
    
    echo
    
    # Setup home-manager (common for all systems)
    if ! setup_home_manager; then
        log_error "home-manager setup failed!"
        log_warning "You may need to fix configuration errors and run manually"
        echo
        log_info "After fixing, run: home-manager switch --flake ~/.config/home-manager#$(get_hm_user)"
        exit 1
    fi
    
    echo
    
    # Setup dotfile symlinks (common for all systems)
    if ! setup_symlinks; then
        log_error "Dotfile symlinking failed!"
        log_warning "You may need to run symlinkmanager manually"
        echo
        log_info "To fix, run: cd ~/.dotfiles && bin/symlinkmanager link all"
    fi
    
    echo
    log_success "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    log_success "‚ïë     Bootstrap Complete! üéâ             ‚ïë"
    log_success "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo
    
    log_info "Your dotfiles are now installed and configured."
    log_info "Dotfiles location: $DOTFILES_DIR"
    log_info "home-manager config: ~/.config/home-manager"
    echo
    
    log_info "Next steps:"
    case $SYSTEM in
        nixos)
            log_info "‚Ä¢ Your system is ready to use!"
            log_info "‚Ä¢ Start Hyprland with: Hyprland"
            log_info "‚Ä¢ To update system: sudo nixos-rebuild switch --flake ~/.dotfiles/nix/nixos"
            log_info "‚Ä¢ To update home: home-manager switch --flake ~/.config/home-manager#$(get_hm_user)"
            ;;
        darwin)
            log_info "‚Ä¢ Restart your terminal or run: exec \$SHELL"
            log_info "‚Ä¢ To update: darwin-rebuild switch --flake ~/.dotfiles/nix/darwin"
            log_info "‚Ä¢ To update home: home-manager switch --flake ~/.config/home-manager#$(get_hm_user)"
            ;;
        linux)
            log_info "‚Ä¢ Restart your terminal or run: exec \$SHELL"
            log_info "‚Ä¢ To update home: home-manager switch --flake ~/.config/home-manager#$(get_hm_user)"
            ;;
    esac
    echo
    
    # Only offer reboot for fresh installations
    if [ "$SYSTEM" = "nixos" ] && [ ! -f "$HOME/.config/.bootstrap_complete" ]; then
        # Mark as complete
        mkdir -p "$HOME/.config"
        touch "$HOME/.config/.bootstrap_complete"
        
        if confirm "This looks like a fresh install. Reboot now?"; then
            log_info "Rebooting..."
            sudo reboot
        else
            log_info "Remember to reboot or restart your shell for all changes to take effect"
        fi
    else
        log_info "Restart your shell or reboot for all changes to take effect"
    fi
}

main "$@"
