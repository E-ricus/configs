#!/usr/bin/env bash
# Bootstrap script for post-installation setup
# Works on NixOS, macOS, and other Linux distributions
# Usage:
#   Download first: curl -fsSL https://raw.githubusercontent.com/e-ricus/configs/main/bootstrap/1 > setup.sh
#   Then run: bash setup.sh

set -euo pipefail

# Source shared functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/lib.sh" ]; then
    source "$SCRIPT_DIR/lib.sh"
else
    # If running from curl, download lib.sh
    eval "$(curl -fsSL https://raw.githubusercontent.com/e-ricus/configs/main/bootstrap/lib.sh)"
fi

CONFIGS_DIR="$HOME/configs"

setup_nixos() {
    log_info "=== Setting up NixOS ==="

    # For NixOS post-install, we're running as root
    CONFIGS_DIR="/root/configs"

    # Check if configs exist, if not clone
    if [ ! -d "$CONFIGS_DIR" ]; then
        log_info "Cloning configs repository..."
        ensure_git
        clone_configs "$CONFIGS_DIR"
    else
        log_success "Configs already exist at $CONFIGS_DIR"
    fi

    # Prompt user for architecture/system selection
    echo
    log_info "Select your system configuration:"
    echo "  1) laptop-amd (Intel/AMD 64-bit)"
    echo "  2) laptop-lenovo (Intel/AMD 64-bit) and nvidia graphics"
    echo "  3) vm-aarch64 (ARM 64-bit)"
    echo

    local flake_config=""
    local hw_config_dest=""
    while true; do
        read -p "Enter selection (1, 2, or 3): " arch_selection
        case $arch_selection in
            1)
                flake_config="laptop-amd"
                hw_config_dest="$CONFIGS_DIR/nix/hosts/nixos/laptop-amd/hardware-configuration.nix"
                break
                ;;
            2)
                flake_config="laptop-lenovo"
                hw_config_dest="$CONFIGS_DIR/nix/hosts/nixos/laptop-lenovo/hardware-configuration.nix"
                break
                ;;
            3)
                flake_config="vm-aarch64"
                hw_config_dest="$CONFIGS_DIR/nix/hosts/nixos/vm-aarch64/hardware-configuration.nix"
                break
                ;;
            *)
                log_error "Invalid selection. Please enter 1, 2, or 3."
                ;;
        esac
    done

    log_info "Using flake configuration: $flake_config"
    echo

    # Copy hardware-configuration.nix from /etc/nixos to configs
    log_info "Copying hardware-configuration.nix to configs..."
    if [ -f /etc/nixos/hardware-configuration.nix ]; then
        # Ensure destination directory exists
        mkdir -p "$(dirname "$hw_config_dest")"
        cp /etc/nixos/hardware-configuration.nix "$hw_config_dest"
        log_success "Hardware configuration copied to configs"
    else
        log_error "Hardware configuration not found at /etc/nixos/hardware-configuration.nix"
        log_error "Cannot proceed without hardware configuration"
        exit 1
    fi

    echo
    log_info "Hardware configuration is now in:"
    log_info "  $hw_config_dest"
    echo

    # Rebuild using flake
    log_info "Rebuilding NixOS from flake..."
    log_info "This may take several minutes on first run..."
    echo

    cd "$CONFIGS_DIR/nix"
    if nixos-rebuild switch --flake ".#$flake_config"; then
        log_success "NixOS rebuilt successfully with flake!"
        log_info "Note: home-manager is integrated in the system rebuild"
    else
        log_error "Failed to rebuild NixOS!"
        log_info "You can try manually with:"
        log_info "  cd $CONFIGS_DIR/nix && nixos-rebuild switch --flake .#$flake_config"
        exit 1
    fi

    # Set user password
    echo
    log_info "Setting password for user 'ericus'..."
    if passwd ericus; then
        log_success "User password set successfully"
    else
        log_warning "Failed to set user password. You can set it later with: passwd ericus"
    fi

    # Clone configs to user's home and set permissions
    echo
    log_info "Setting up configs in user home directory..."

    USER_CONFIGS="/home/ericus/configs"
    if [ ! -d "$USER_CONFIGS" ]; then
        log_info "Cloning configs to /home/ericus/configs..."
        git clone https://github.com/e-ricus/configs.git "$USER_CONFIGS"

        # Set ownership to user
        chown -R ericus:users "$USER_CONFIGS"
        log_success "Configs cloned and ownership set to ericus"
    else
        log_info "Configs already exist at $USER_CONFIGS"
        # Ensure correct ownership anyway
        chown -R ericus:users "$USER_CONFIGS"
    fi

    # Clean up root's configs
    if [ -d "/root/configs" ]; then
        log_info "Cleaning up /root/configs..."
        rm -rf "/root/configs"
        log_success "Root configs cleaned up"
    fi

    echo
    log_success "Setup complete! Configs are ready at /home/ericus/configs"
    log_info "When you login as ericus, you can use the 'hm' and 'nos' aliases"
}

setup_darwin() {
    log_info "=== Setting up macOS with nix-darwin ==="

    # Check if Nix is installed
    if ! command_exists nix; then
        log_error "Nix is not installed!"
        echo
        log_info "Please install Nix first using the Determinate Systems installer:"
        log_info "  curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install"
        echo
        log_info "After installing Nix, restart your terminal and run this script again."
        exit 1
    fi

    log_success "Nix is installed"

    # Ensure git
    ensure_git

    # Clone configs if needed
    if [ ! -d "$CONFIGS_DIR" ]; then
        log_info "Cloning configs to $CONFIGS_DIR..."
        clone_configs "$CONFIGS_DIR"
    else
        log_success "Configs already exist at $CONFIGS_DIR"
    fi

    # Check if unified flake exists
    if [ ! -f "$CONFIGS_DIR/nix/flake.nix" ]; then
        log_error "Unified flake not found!"
        log_error "Expected: $CONFIGS_DIR/nix/flake.nix"
        exit 1
    fi

    # Install nix-darwin with unified flake
    log_info "Installing nix-darwin with unified flake..."
    log_info "This may take several minutes on first run..."
    echo

    cd "$CONFIGS_DIR/nix"
    if sudo nix run nix-darwin/master#darwin-rebuild -- switch --flake ".#work-mac"; then
        log_success "nix-darwin installed and configured"
        log_info "Note: home-manager is integrated in the darwin rebuild"
    else
        log_error "Failed to install nix-darwin!"
        log_info "You can try manually with:"
        log_info "  cd ~/configs/nix && sudo nix run nix-darwin/master#darwin-rebuild -- switch --flake .#work-mac"
        exit 1
    fi
}

setup_linux() {
    # TODO: Implement setup for other Linux distributions
    # This should:
    #   1. Check if Nix is installed, if not fail and prompt to install with Determinate Systems
    #   2. Ensure git is installed
    #   3. Clone configs repository if not present
    #   4. Set up standalone home-manager configuration
    #   5. Apply home-manager switch --flake ~/configs/nix#ericus

    log_error "Other Linux distributions are not yet supported in this bootstrap script"
    log_info "Please install Nix manually using Determinate Systems installer:"
    log_info "  curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install"
    exit 1
}

setup_home_manager() {
    local system=$(detect_system)

    # For NixOS and Darwin, home-manager is integrated in system rebuild
    if [ "$system" = "nixos" ] || [ "$system" = "darwin" ]; then
        log_info "=== Home-manager setup ==="
        log_success "home-manager is already integrated in your system configuration"
        log_info "It was included in the system rebuild"
        echo
        log_info "Optional: You can also use standalone home-manager for quick iterations:"
        log_info "  home-manager switch --flake ~/configs/nix#$(get_hm_user)"
        echo
        return 0
    fi

    # For regular Linux, set up standalone home-manager
    log_info "=== Setting up standalone home-manager ==="

    # Check if unified flake exists
    if [ ! -f "$CONFIGS_DIR/nix/flake.nix" ]; then
        log_error "Unified flake not found at $CONFIGS_DIR/nix/flake.nix"
        log_error "Cannot proceed with home-manager setup"
        return 1
    fi

    # Determine which user configuration to use
    local hm_user=$(get_hm_user)
    log_info "Using home-manager configuration for: $hm_user"

    # Check if the user configuration exists
    local user_config=""
    case $system in
        linux)
            user_config="$CONFIGS_DIR/nix/home/linux.nix"
            ;;
    esac

    if [ ! -f "$user_config" ]; then
        log_error "User configuration not found: $user_config"
        return 1
    fi

    # Apply home-manager configuration directly from unified flake
    log_info "Applying home-manager configuration..."
    log_info "This may take several minutes on first run..."
    echo

    if home-manager switch --flake "$CONFIGS_DIR/nix#$hm_user"; then
        log_success "home-manager configured successfully"
    else
        log_error "home-manager switch failed!"
        log_info "You can try manually with: home-manager switch --flake ~/configs/nix#$hm_user"
        return 1
    fi
}

setup_symlinks() {
    log_info "=== Setting up config symlinks ==="

    # Verify symlinkmanager exists
    if [ ! -x "$CONFIGS_DIR/bin/symlinkmanager" ]; then
        log_error "symlinkmanager not found at $CONFIGS_DIR/bin/symlinkmanager"
        log_error "Cannot proceed with config symlinking"
        return 1
    fi

    # Verify symlink.conf exists
    if [ ! -f "$CONFIGS_DIR/symlink.conf" ]; then
        log_error "symlink.conf not found at $CONFIGS_DIR/symlink.conf"
        log_error "Cannot proceed with config symlinking"
        return 1
    fi

    # Run symlinkmanager
    stow_configs "$CONFIGS_DIR"

    log_success "All configs symlinked"
}

main() {
    echo
    log_info "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    log_info "‚ïë   Configs Bootstrap - Post Install    ‚ïë"
    log_info "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo
    
    # Detect system
    SYSTEM=$(detect_system)
    log_info "Detected system: $SYSTEM"
    echo
    
    # System-specific setup
    case $SYSTEM in
        nixos)
            setup_nixos
            ;;
        darwin)
            if ! setup_darwin; then
                log_warning "Darwin setup failed or was skipped"
                log_info "Continuing with home-manager setup..."
            fi
            ;;
        linux)
            setup_linux
            ;;
        *)
            log_error "Unsupported system type: $SYSTEM"
            exit 1
            ;;
    esac
    
    echo

    # Setup home-manager (integrated for NixOS/Darwin, standalone for Linux)
    if ! setup_home_manager; then
        log_error "home-manager setup failed!"
        log_warning "You may need to fix configuration errors and run manually"
        echo
        log_info "After fixing, run: home-manager switch --flake ~/configs/nix#$(get_hm_user)"
        exit 1
    fi
    
    echo
    
    # Setup config symlinks (common for all hosts)
    if ! setup_symlinks; then
        log_error "Config symlinking failed!"
        log_warning "You may need to run symlinkmanager manually"
        echo
        log_info "To fix, run: cd ~/configs && bin/symlinkmanager link all"
    fi

    echo
    log_success "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    log_success "‚ïë     Bootstrap Complete! üéâ             ‚ïë"
    log_success "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo

    log_info "Your configs are now installed and configured."
    log_info "Configs location: $CONFIGS_DIR"
    log_info "Unified flake: ~/configs/nix/flake.nix"
    echo

    log_info "Next steps:"
    case $SYSTEM in
        nixos)
            log_info "‚Ä¢ Your system is ready to use!"
            log_info "‚Ä¢ Start Hyprland with: Hyprland"
            echo
            log_info "Commands (or use aliases):"
            log_info "‚Ä¢ System rebuild (includes home-manager):"
            log_info "    sudo nixos-rebuild switch --flake ~/configs/nix#laptop-amd"
            log_info "    Alias: nos (update the alias in fish/zsh config to your host)"
            log_info "‚Ä¢ Quick home-manager only update:"
            log_info "    home-manager switch --flake ~/configs/nix#$(get_hm_user)"
            log_info "    Alias: hm"
            ;;
        darwin)
            log_info "‚Ä¢ Restart your terminal or run: exec \$SHELL"
            echo
            log_info "Commands (or use aliases):"
            log_info "‚Ä¢ System rebuild (includes home-manager):"
            log_info "    darwin-rebuild switch --flake ~/configs/nix#work-mac"
            log_info "    Alias: nom"
            log_info "‚Ä¢ Quick home-manager only update:"
            log_info "    home-manager switch --flake ~/configs/nix#$(get_hm_user)"
            log_info "    Alias: hm"
            ;;
        linux)
            log_info "‚Ä¢ Restart your terminal or run: exec \$SHELL"
            log_info "‚Ä¢ To update home-manager:"
            log_info "    home-manager switch --flake ~/configs/nix#$(get_hm_user)"
            log_info "    Alias: hm"
            ;;
    esac
    echo
    
    # Only offer reboot for fresh installations
    if [ "$SYSTEM" = "nixos" ] && [ ! -f "$HOME/.config/.bootstrap_complete" ]; then
        # Mark as complete
        mkdir -p "$HOME/.config"
        touch "$HOME/.config/.bootstrap_complete"
        
        if confirm "This looks like a fresh install. Reboot now?"; then
            log_info "Rebooting..."
            sudo reboot
        else
            log_info "Remember to reboot or restart your shell for all changes to take effect"
        fi
    else
        log_info "Restart your shell or reboot for all changes to take effect"
    fi
}

main "$@"
